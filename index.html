<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>文字入れツール</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800;900&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #1a1a2e;
    color: #e0e0e0;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 { font-size: 1.1rem; padding: 10px 0 4px; color: #a0a0c0; letter-spacing: 0.1em; }
  .app { display: flex; gap: 14px; padding: 10px; width: 100%; max-width: 1400px; flex-wrap: wrap; justify-content: center; }
  .canvas-wrap { position: relative; flex-shrink: 0; background: #000; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 24px rgba(0,0,0,0.5); }
  .canvas-wrap img { display: block; max-height: 82vh; max-width: min(100%, 600px); width: auto; height: auto; }
  .text-box {
    position: absolute; cursor: grab; writing-mode: vertical-rl; text-orientation: mixed;
    white-space: pre-wrap; user-select: none; line-height: 1.6;
    font-family: 'M PLUS Rounded 1c', sans-serif; font-weight: 800; z-index: 10; padding: 4px;
  }
  .text-box.active { outline: 2px dashed rgba(255,255,255,0.5); }
  .text-box.dragging { cursor: grabbing; opacity: 0.85; }
  .ctrl {
    background: #16213e; border-radius: 10px; padding: 14px; min-width: 290px; max-width: 360px;
    display: flex; flex-direction: column; gap: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    max-height: 88vh; overflow-y: auto;
  }
  .stitle { font-size: 0.8rem; color: #7a7aaf; border-bottom: 1px solid #2a2a4a; padding-bottom: 3px; font-weight: 700; }
  .tabs { display: flex; gap: 5px; }
  .tab {
    flex: 1; padding: 7px 10px; border: 2px solid #3a3a6a; background: transparent;
    color: #a0a0c0; border-radius: 7px; cursor: pointer; font-family: inherit; font-weight: 700; font-size: 0.82rem; transition: all 0.2s;
  }
  .tab.on { background: #3a3a6a; color: #fff; border-color: #6a6aaf; }
  .tab:hover { border-color: #6a6aaf; }
  .cg { display: flex; flex-direction: column; gap: 5px; }
  label { font-size: 0.78rem; color: #9090b0; font-weight: 700; }
  textarea {
    background: #0f1a30; border: 1px solid #3a3a6a; border-radius: 7px; color: #e0e0e0;
    padding: 8px; font-family: inherit; font-size: 0.9rem; resize: vertical; min-height: 70px;
    writing-mode: vertical-rl; line-height: 1.8;
  }
  textarea:focus { outline: none; border-color: #6a6aaf; }
  input[type="range"] { width: 100%; accent-color: #6a6aaf; }
  input[type="color"] { width: 44px; height: 30px; border: 2px solid #3a3a6a; border-radius: 5px; background: transparent; cursor: pointer; padding: 2px; }
  .row { display: flex; align-items: center; gap: 8px; }
  .row label { min-width: 76px; }
  .vd { font-size: 0.78rem; color: #6a6aaf; min-width: 34px; text-align: right; }
  .btn {
    padding: 7px 14px; border: none; border-radius: 7px; cursor: pointer;
    font-family: inherit; font-weight: 700; font-size: 0.82rem; transition: all 0.2s;
  }
  .bp { background: #4a4a8a; color: #fff; }
  .bp:hover { background: #5a5a9a; }
  .bd { background: #6a2a2a; color: #e0a0a0; }
  .bd:hover { background: #7a3a3a; }
  .be { background: #2a6a4a; color: #a0e0c0; width: 100%; padding: 11px; font-size: 0.95rem; margin-top: 6px; }
  .be:hover { background: #3a7a5a; }
  .upload {
    border: 2px dashed #3a3a6a; border-radius: 7px; padding: 16px; text-align: center;
    cursor: pointer; color: #7a7aaf; font-size: 0.82rem; transition: border-color 0.2s;
  }
  .upload:hover { border-color: #6a6aaf; }
  .ar { display: flex; gap: 5px; }
  .ar .btn { flex: 1; }
</style>
</head>
<body>
<h1>縦書き文字入れツール</h1>
<div class="app">
  <div class="canvas-wrap" id="cw">
    <img id="img" src="" alt="画像をアップロード">
  </div>
  <div class="ctrl">
    <div class="cg">
      <div class="stitle">画像</div>
      <div class="upload" id="ua" onclick="document.getElementById('fi').click()">クリックまたはドロップで画像読込</div>
      <input type="file" id="fi" accept="image/*" style="display:none">
    </div>
    <div class="cg">
      <div class="stitle">テキストボックス</div>
      <div class="tabs">
        <button class="tab on" data-b="0" onclick="sel(0)">テキスト1</button>
        <button class="tab" data-b="1" onclick="sel(1)">テキスト2</button>
      </div>
    </div>
    <div class="cg">
      <label>テキスト内容</label>
      <textarea id="ti" placeholder="ここに文字を入力"></textarea>
    </div>
    <div class="cg">
      <div class="row"><label>文字サイズ</label><input type="range" id="fs" min="12" max="80" value="28"><span class="vd" id="fsv">28</span></div>
    </div>
    <div class="cg">
      <div class="row"><label>字間</label><input type="range" id="ls" min="-5" max="20" value="2"><span class="vd" id="lsv">2</span></div>
    </div>
    <div class="cg">
      <div class="row"><label>行間</label><input type="range" id="lh" min="10" max="40" value="16"><span class="vd" id="lhv">1.6</span></div>
    </div>
    <div class="cg">
      <div class="row"><label>文字色</label><input type="color" id="tc" value="#ffffff"></div>
    </div>
    <div class="cg">
      <div class="stitle">枠線（ストローク）</div>
      <div class="row"><label>枠線の太さ</label><input type="range" id="sw" min="0" max="10" value="2" step="0.5"><span class="vd" id="swv">2</span></div>
      <div class="row"><label>枠線の色</label><input type="color" id="sc" value="#000000"></div>
    </div>
    <div class="cg">
      <div class="row"><label>太さ</label><input type="range" id="fw" min="400" max="900" value="800" step="100"><span class="vd" id="fwv">800</span></div>
    </div>
    <div class="ar">
      <button class="btn bp" id="tb" onclick="tog()">非表示</button>
      <button class="btn bd" onclick="rst()">位置リセット</button>
    </div>
    <button class="btn be" onclick="exp()">画像として保存</button>
  </div>
</div>
<script>
const B=[
  {text:'\u300c\u305d\u3046\u3001\u305d\u308c\u3067\uff1f\u300d\n\u3044\u308a\u3059\u306e\u76ee\u304c\u50d5\u3092\u898b\u3064\u3081\u308b\u2026\u3002',x:20,y:20,fs:28,ls:2,lh:1.6,c:'#ffffff',sw:2,sc:'#000000',fw:800,vis:true},
  {text:'\u3042\u3042\u30fc\u50d5\u306f\u300c\u751f\u304d\u6b8b\u308c\u308b\u300d\u306e\u304b\n\u305d\u308c\u3068\u3082\u300c\u3053\u306e\u307e\u307e\u300d\u3053\u3053\u3067',x:200,y:20,fs:24,ls:2,lh:1.6,c:'#ffffff',sw:2,sc:'#000000',fw:800,vis:false}
];
let ab=0,drag=false,dx=0,dy=0;
const cw=document.getElementById('cw'),img=document.getElementById('img');
const els=[];
for(let i=0;i<2;i++){const e=document.createElement('div');e.className='text-box';e.dataset.i=i;cw.appendChild(e);els.push(e);}

document.getElementById('fi').addEventListener('change',e=>{const f=e.target.files[0];if(f)loadImg(f);});
const ua=document.getElementById('ua');
ua.addEventListener('dragover',e=>{e.preventDefault();ua.style.borderColor='#6a6aaf';});
ua.addEventListener('dragleave',()=>{ua.style.borderColor='#3a3a6a';});
ua.addEventListener('drop',e=>{e.preventDefault();ua.style.borderColor='#3a3a6a';const f=e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))loadImg(f);});
function loadImg(f){const r=new FileReader();r.onload=e=>{img.src=e.target.result;ua.textContent=f.name;};r.readAsDataURL(f);}

const ti=document.getElementById('ti'),fs=document.getElementById('fs'),ls=document.getElementById('ls'),lh=document.getElementById('lh'),tc=document.getElementById('tc'),sw=document.getElementById('sw'),sc=document.getElementById('sc'),fw=document.getElementById('fw');
ti.addEventListener('input',()=>{B[ab].text=ti.value;render();});
fs.addEventListener('input',()=>{B[ab].fs=+fs.value;document.getElementById('fsv').textContent=fs.value;render();});
ls.addEventListener('input',()=>{B[ab].ls=+ls.value;document.getElementById('lsv').textContent=ls.value;render();});
lh.addEventListener('input',()=>{B[ab].lh=+lh.value/10;document.getElementById('lhv').textContent=(+lh.value/10).toFixed(1);render();});
tc.addEventListener('input',()=>{B[ab].c=tc.value;render();});
sw.addEventListener('input',()=>{B[ab].sw=+sw.value;document.getElementById('swv').textContent=sw.value;render();});
sc.addEventListener('input',()=>{B[ab].sc=sc.value;render();});
fw.addEventListener('input',()=>{B[ab].fw=+fw.value;document.getElementById('fwv').textContent=fw.value;render();});

function sel(i){ab=i;document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));document.querySelector('.tab[data-b="'+i+'"]').classList.add('on');lc();render();}
function lc(){const b=B[ab];ti.value=b.text;fs.value=b.fs;document.getElementById('fsv').textContent=b.fs;ls.value=b.ls;document.getElementById('lsv').textContent=b.ls;lh.value=Math.round(b.lh*10);document.getElementById('lhv').textContent=b.lh.toFixed(1);tc.value=b.c;sw.value=b.sw;document.getElementById('swv').textContent=b.sw;sc.value=b.sc;fw.value=b.fw;document.getElementById('fwv').textContent=b.fw;document.getElementById('tb').textContent=b.vis?'非表示':'表示';}
function tog(){B[ab].vis=!B[ab].vis;document.getElementById('tb').textContent=B[ab].vis?'非表示':'表示';render();}
function rst(){B[ab].x=ab*180+20;B[ab].y=20;render();}

function render(){
  for(let i=0;i<2;i++){
    const b=B[i],e=els[i];
    if(!b.vis){e.style.display='none';continue;}
    e.style.display='block';e.style.left=b.x+'px';e.style.top=b.y+'px';
    e.style.fontSize=b.fs+'px';e.style.letterSpacing=b.ls+'px';e.style.lineHeight=b.lh;
    e.style.color=b.c;e.style.fontWeight=b.fw;
    if(b.sw>0){e.style.webkitTextStroke=b.sw+'px '+b.sc;e.style.paintOrder='stroke fill';
      e.style.textShadow=b.sc+' 0 0 '+b.sw+'px,'+b.sc+' 0 0 '+b.sw+'px';
    }else{e.style.webkitTextStroke='none';e.style.textShadow='none';}
    e.textContent=b.text;
    e.className='text-box'+(i===ab?' active':'');
  }
}

function gp(e){return e.touches?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY};}
function sd(e,i){e.preventDefault();ab=i;sel(i);drag=true;const p=gp(e),r=cw.getBoundingClientRect();dx=p.x-r.left-B[i].x;dy=p.y-r.top-B[i].y;els[i].classList.add('dragging');}
function md(e){if(!drag)return;e.preventDefault();const p=gp(e),r=cw.getBoundingClientRect();B[ab].x=Math.max(0,p.x-r.left-dx);B[ab].y=Math.max(0,p.y-r.top-dy);render();}
function ed(){if(!drag)return;drag=false;els.forEach(e=>e.classList.remove('dragging'));}
els.forEach((e,i)=>{e.addEventListener('mousedown',ev=>sd(ev,i));e.addEventListener('touchstart',ev=>sd(ev,i),{passive:false});});
document.addEventListener('mousemove',md);document.addEventListener('touchmove',md,{passive:false});
document.addEventListener('mouseup',ed);document.addEventListener('touchend',ed);

function exp(){
  if(!img.src||!img.naturalWidth){alert('画像を先にアップロードしてください');return;}
  const cv=document.createElement('canvas'),cx=cv.getContext('2d');
  const nw=img.naturalWidth,nh=img.naturalHeight;cv.width=nw;cv.height=nh;
  cx.drawImage(img,0,0,nw,nh);
  const sx=nw/img.clientWidth,sy=nh/img.clientHeight;
  for(let i=0;i<2;i++){
    const b=B[i];if(!b.vis||!b.text)continue;
    const fz=b.fs*sy,lsp=b.ls*sy,stw=b.sw*sy;
    cx.font=b.fw+' '+fz+'px "M PLUS Rounded 1c", sans-serif';cx.textBaseline='top';
    const lines=b.text.split('\n');let colX=b.x*sx;
    for(let li=0;li<lines.length;li++){
      const ch=Array.from(lines[li]);let cy2=b.y*sy;
      for(let ci=0;ci<ch.length;ci++){
        if(stw>0){cx.strokeStyle=b.sc;cx.lineWidth=stw*2;cx.lineJoin='round';cx.strokeText(ch[ci],colX,cy2);}
        cx.fillStyle=b.c;cx.fillText(ch[ci],colX,cy2);cy2+=fz+lsp;
      }
      colX+=fz*b.lh;
    }
  }
  const a=document.createElement('a');a.download='text_overlay.png';a.href=cv.toDataURL('image/png');a.click();
}

B[0].vis=true;lc();render();
</script>
</body>
</html>
